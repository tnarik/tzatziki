#!/usr/bin/env ruby
require 'cucumber'
require 'cucumber/runtime'
require 'cucumber/cli/configuration'

path = ARGV[0] || "."

@env_args = ["FOO=#{path}"]



false && (
def configuration
  @configuration ||= Cucumber::Cli::Configuration.new(STDOUT, STDERR).tap do |configuration|
    configuration.parse!(@env_args)
    Cucumber.logger = configuration.log
  end

  MyConfiguration.new()
end

class MyConfiguration

      def all_files_to_load
        requires = [ 'features' ]
        files = requires.map do |path|
          path = path.gsub(/\\/, '/') # In case we're on windows. Globs don't work with backslashes.
          path = path.gsub(/\/$/, '') # Strip trailing slash.
          File.directory?(path) ? Dir["#{path}/**/*"] : path
        end.flatten.uniq
        #remove_excluded_files_from(files)
        files.reject! {|f| !File.file?(f)}
        files.reject! {|f| File.extname(f) == '.feature' }
        files.reject! {|f| f =~ /^http/}
        files.sort
      end

      def files_to_load
        ["features"]
      end

      def support_to_load
                p all_files_to_load


        support_files = all_files_to_load.select {|f| f =~ %r{/support/} }
        env_files = support_files.select {|f| f =~ %r{/support/env\..*} }
        other_files = support_files - env_files

        p support_files
        p env_files
        p other_files
      end


      def step_defs_to_load
        files_to_load.reject {|f| f =~ %r{/support/} }
      end
end


#Cucumber::Cli::Main.new(env_args).execute!
r = Cucumber::Runtime.new(configuration)
r.run!

)


# Directly with cucumber core (hexagonal architecture)
  features_glob = 'features/**/*.feature'
  feature_files = Dir[features_glob].reject { |f| f =~ /iso-8859-1/ }
  puts "Running features:"
  p feature_files

  require 'cucumber/core'

  require 'cucumber/core/gherkin/document'
  features = feature_files.map do |file|
    Cucumber::Core::Gherkin::Document.new(file, File.read(file))
  end


  require 'cucumber/mappings'
  mappings = Cucumber::Mappings.new



  extend Cucumber::Core
  execute features, mappings, []
